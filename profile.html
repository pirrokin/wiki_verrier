<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votre Espace - Technician Wiki</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 500;
            min-height: 24px;
            /* Prevent layout shift if empty */
        }

        .info-group {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-brand">
            <img src="images/logo.png" alt="Logo" class="nav-logo">
            Technician Wiki
        </div>
        <div class="nav-links">
            <button class="nav-btn" id="homeBtn" onclick="window.location.href='admin.html'">Accueil</button>
            <button class="nav-btn" onclick="window.location.href='pdms.html'">PDMS</button>
            <button class="nav-btn" onclick="window.location.href='documentation.html'">Documentation</button>
            <button class="nav-btn" id="adminInterfaceBtn"
                onclick="window.location.href='admin_interface.html'">Adminterface</button>
            <button class="nav-btn active">Votre Espace</button>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="welcome-section">
            <div>
                <h1 class="welcome-title">Votre Espace</h1>
                <p class="welcome-subtitle">Gérez vos informations personnelles</p>
            </div>
            <button class="btn-primary" onclick="openEditModal()">Modifier mes infos</button>
        </div>

        <div class="profile-grid">
            <!-- Personal Info Card (View Only) -->
            <div class="login-card" style="max-width: 100%; text-align: left;">
                <h2 style="margin-bottom: 30px;">Informations Personnelles</h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="info-group">
                        <div class="info-label">Nom</div>
                        <div class="info-value" id="viewLastname">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">Prénom</div>
                        <div class="info-value" id="viewFirstname">-</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="info-group">
                        <div class="info-label">Email</div>
                        <div class="info-value" id="viewEmail">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">Téléphone</div>
                        <div class="info-value" id="viewPhone">-</div>
                    </div>
                </div>

                <div class="info-group">
                    <div class="info-label">Adresse</div>
                    <div class="info-value" id="viewAddress">-</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="info-group">
                        <div class="info-label">Date de naissance</div>
                        <div class="info-value" id="viewBirthdate">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">Sexe</div>
                        <div class="info-value" id="viewGender">-</div>
                    </div>
                </div>
            </div>

            <!-- Security Settings Card -->
            <div class="login-card" style="max-width: 100%; text-align: left; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Paramètres de Connexion</h2>
                    <button class="btn-secondary" id="editSecurityBtn" style="padding: 8px 16px;">Modifier</button>
                </div>

                <!-- View Mode -->
                <div id="securityViewMode" class="profile-info">
                    <div class="info-group">
                        <div class="info-label">Identifiant</div>
                        <div class="info-value" id="viewUsername">...</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">Mot de passe</div>
                        <div class="info-value">********</div>
                    </div>
                </div>

                <!-- Edit Mode -->
                <form id="securityEditMode" class="profile-form"
                    style="display: none; grid-template-columns: 1fr; gap: 15px;" autocomplete="off">
                    <div class="input-group">
                        <label>Nouvel Identifiant</label>
                        <input type="text" id="editUsername" class="form-input"
                            style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 6px; background: #222; color: white;"
                            autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label>Mot de passe actuel <span style="color:red">*</span></label>
                        <input type="password" id="currentPassword" class="form-input" required
                            placeholder="Obligatoire pour valider"
                            style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 6px; background: #222; color: white;"
                            autocomplete="new-password">
                    </div>
                    <div class="input-group">
                        <label>Nouveau mot de passe</label>
                        <input type="password" id="newPassword" class="form-input"
                            placeholder="Laisser vide pour ne pas changer"
                            style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 6px; background: #222; color: white;"
                            autocomplete="new-password">
                    </div>
                    <div class="input-group">
                        <label>Confirmer nouveau mot de passe</label>
                        <input type="password" id="confirmNewPassword" class="form-input"
                            style="width: 100%; padding: 10px; border: 1px solid #444; border-radius: 6px; background: #222; color: white;"
                            autocomplete="new-password">
                    </div>
                    <div class="form-actions"
                        style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                        <button type="button" class="btn-secondary" id="cancelSecurityBtn">Annuler</button>
                        <button type="submit" class="btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>

            <!-- Future Placeholders -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="login-card"
                    style="max-width: 100%; min-height: 200px; display: flex; align-items: center; justify-content: center; border: 2px dashed #333;">
                    <p style="color: #555;">Graphique: Suivi de publication</p>
                </div>
                <div class="login-card"
                    style="max-width: 100%; min-height: 200px; display: flex; align-items: center; justify-content: center; border: 2px dashed #333;">
                    <p style="color: #555;">Graphique: Mises à jour PDMS</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeEditModal()">&times;</button>
            <h2>Modifier mes informations</h2>
            <p class="subtitle" style="margin-bottom: 20px;">Mettez à jour votre profil</p>

            <form id="profileForm" autocomplete="off">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label for="lastname">Nom</label>
                        <input type="text" id="lastname" name="lastname" placeholder="Votre nom">
                    </div>
                    <div class="input-group">
                        <label for="firstname">Prénom</label>
                        <input type="text" id="firstname" name="firstname" placeholder="Votre prénom">
                    </div>
                </div>

                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="exemple@email.com">
                </div>

                <div class="input-group">
                    <label for="phone">Téléphone</label>
                    <input type="tel" id="phone" name="phone" placeholder="06 12 34 56 78">
                </div>

                <div class="input-group">
                    <label for="address">Adresse</label>
                    <input type="text" id="address" name="address" placeholder="Votre adresse complète">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label for="birthdate">Date de naissance</label>
                        <input type="date" id="birthdate" name="birthdate">
                    </div>
                    <div class="input-group">
                        <label for="gender">Sexe</label>
                        <select id="gender" name="gender">
                            <option value="">Non renseigné</option>
                            <option value="M">Homme</option>
                            <option value="F">Femme</option>
                            <option value="Other">Autre</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn-login">Enregistrer les modifications</button>
            </form>
        </div>
    </div>

    <script>
        const username = localStorage.getItem('username');
        if (!username) window.location.href = 'index.html';

        // Elements
        const modal = document.getElementById('editProfileModal');
        const form = document.getElementById('profileForm');

        // --- Security Section Logic ---
        const securityViewMode = document.getElementById('securityViewMode');
        const securityEditMode = document.getElementById('securityEditMode');
        const editSecurityBtn = document.getElementById('editSecurityBtn');
        const cancelSecurityBtn = document.getElementById('cancelSecurityBtn');

        editSecurityBtn.addEventListener('click', () => {
            securityViewMode.style.display = 'none';
            securityEditMode.style.display = 'grid';
            editSecurityBtn.style.display = 'none';
            document.getElementById('editUsername').value = document.getElementById('viewUsername').textContent;
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        });

        cancelSecurityBtn.addEventListener('click', () => {
            securityEditMode.style.display = 'none';
            securityViewMode.style.display = 'grid';
            editSecurityBtn.style.display = 'block';
        });

        securityEditMode.addEventListener('submit', (e) => {
            e.preventDefault();
            const currentUsername = username; // From localStorage
            const newUsername = document.getElementById('editUsername').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword && newPassword !== confirmNewPassword) {
                alert('Les nouveaux mots de passe ne correspondent pas.');
                return;
            }

            fetch('/api/account', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    currentUsername,
                    currentPassword,
                    newUsername: newUsername !== currentUsername ? newUsername : null,
                    newPassword: newPassword || null
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Compte mis à jour avec succès.');
                        if (data.newUsername !== currentUsername || newPassword) {
                            alert('Vos identifiants ont changé. Veuillez vous reconnecter.');
                            localStorage.removeItem('username');
                            window.location.href = 'index.html';
                        } else {
                            // Just refresh view
                            document.getElementById('viewUsername').textContent = currentUsername; // Or new if changed but no logout logic triggered (unlikely)
                            cancelSecurityBtn.click();
                        }
                    } else {
                        alert('Erreur: ' + data.message);
                    }
                })
                .catch(err => console.error(err));
        });

        // Load Profile Data
        function loadProfile() {
            fetch(`/api/profile?username=${username}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const user = data.user;

                        // Role-based UI
                        if (user.role !== 'admin') {
                            document.getElementById('adminInterfaceBtn').style.display = 'none';
                            document.getElementById('homeBtn').onclick = () => window.location.href = 'technician.html';
                        }

                        // Update View
                        document.getElementById('viewLastname').innerText = user.lastname || 'Non renseigné';
                        document.getElementById('viewFirstname').innerText = user.firstname || 'Non renseigné';
                        document.getElementById('viewEmail').innerText = user.email || 'Non renseigné';
                        document.getElementById('viewPhone').innerText = user.phone || 'Non renseigné';
                        document.getElementById('viewAddress').innerText = user.address || 'Non renseigné';

                        if (user.birthdate) {
                            const date = new Date(user.birthdate);
                            document.getElementById('viewBirthdate').innerText = date.toLocaleDateString('fr-FR');
                            // Pre-fill form input (needs YYYY-MM-DD)
                            document.getElementById('birthdate').value = date.toISOString().split('T')[0];
                        } else {
                            document.getElementById('viewBirthdate').innerText = 'Non renseigné';
                            document.getElementById('birthdate').value = '';
                        }

                        const genderMap = { 'M': 'Homme', 'F': 'Femme', 'Other': 'Autre' };
                        document.getElementById('viewGender').innerText = genderMap[user.gender] || 'Non renseigné';

                        // Pre-fill form inputs
                        document.getElementById('lastname').value = user.lastname || '';
                        document.getElementById('firstname').value = user.firstname || '';
                        document.getElementById('email').value = user.email || '';
                        document.getElementById('phone').value = user.phone || '';
                        document.getElementById('address').value = user.address || '';
                        document.getElementById('address').value = user.address || '';
                        document.getElementById('gender').value = user.gender || '';

                        // Security View
                        document.getElementById('viewUsername').textContent = user.username;
                    }
                });
        }

        // Modal Functions
        function openEditModal() {
            modal.classList.add('active');
        }

        function closeEditModal() {
            modal.classList.remove('active');
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                closeEditModal();
            }
        }

        // Handle Form Submit
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const formData = {
                username: username,
                lastname: document.getElementById('lastname').value,
                firstname: document.getElementById('firstname').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                birthdate: document.getElementById('birthdate').value || null,
                gender: document.getElementById('gender').value || null
            };

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Enregistrement...';

            fetch('/api/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        closeEditModal();
                        loadProfile(); // Refresh view
                        // Optional: Show a small toast notification instead of alert
                    } else {
                        alert('Erreur : ' + data.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Erreur technique');
                })
                .finally(() => {
                    btn.innerText = originalText;
                });
        });

        // Initial Load
        loadProfile();
    </script>
</body>

</html>